#!/usr/bin/env python3
"""Simulate transfers using the lab's accounts-service.

This script is less about exploiting a bug and more about illustrating how a
legitimate user can perform transfers and how weak authorization checks could
be extended into more serious abuse in future scenarios.
"""

from __future__ import annotations

import argparse
import sys

import requests

AUTH_URL = "http://localhost:8001/login"
ACCOUNTS_BASE = "http://localhost:8002"


def get_token(username: str, password: str) -> str:
    resp = requests.post(AUTH_URL, json={"username": username, "password": password})
    if resp.status_code != 200:
        raise SystemExit(f"login failed: {resp.status_code} {resp.text}")
    data = resp.json()
    return data["access_token"]


def transfer(token: str, from_id: int, to_id: int, amount: float) -> None:
    resp = requests.post(
        f"{ACCOUNTS_BASE}/accounts/transfer",
        json={
            "from_account_id": from_id,
            "to_account_id": to_id,
            "amount": amount,
        },
        headers={"Authorization": f"Bearer {token}"},
    )
    print(f"status={resp.status_code} body={resp.text}")


def main() -> None:
    parser = argparse.ArgumentParser(description="Trigger transfers in the lab accounts-service")
    parser.add_argument("--username", default="alice")
    parser.add_argument("--password", default="password123")
    parser.add_argument("--from-id", type=int, default=2001)
    parser.add_argument("--to-id", type=int, default=2002)
    parser.add_argument("--amount", type=float, default=50.0)
    args = parser.parse_args()

    token = get_token(args.username, args.password)
    print(f"[transfer] got token for {args.username}")
    transfer(token, args.from_id, args.to_id, args.amount)


if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        sys.exit(1)
